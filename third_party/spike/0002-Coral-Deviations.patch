From 37c993499a2f6b87dadaf9032c87857f0fd68a7e Mon Sep 17 00:00:00 2001
From: Alex Van Damme <atv@google.com>
Date: Fri, 16 Jan 2026 02:31:10 +0000
Subject: [PATCH 2/4] Coral Deviations

---
 riscv/csr_init.cc    | 9 +++++++++
 riscv/insns/ebreak.h | 3 ++-
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/riscv/csr_init.cc b/riscv/csr_init.cc
index 4a05a9c7..5dcbb641 100644
--- a/riscv/csr_init.cc
+++ b/riscv/csr_init.cc
@@ -329,6 +329,15 @@ void state_t::csr_init(processor_t* const proc, reg_t max_isa)
   add_csr(CSR_MVENDORID, std::make_shared<const_csr_t>(proc, CSR_MVENDORID, 0));
   add_csr(CSR_MHARTID, std::make_shared<const_csr_t>(proc, CSR_MHARTID, proc->get_id()));
   add_csr(CSR_MCONFIGPTR, std::make_shared<const_csr_t>(proc, CSR_MCONFIGPTR, 0));
+
+  // CoralNPU Custom CSRs
+  add_csr(0xFC0, std::make_shared<basic_csr_t>(proc, 0xFC0, 0)); // KISA
+  add_csr(0xFC4, std::make_shared<basic_csr_t>(proc, 0xFC4, 0)); // KSCM0
+  add_csr(0xFC8, std::make_shared<basic_csr_t>(proc, 0xFC8, 0)); // KSCM1
+  add_csr(0xFCC, std::make_shared<basic_csr_t>(proc, 0xFCC, 0)); // KSCM2
+  add_csr(0xFD0, std::make_shared<basic_csr_t>(proc, 0xFD0, 0)); // KSCM3
+  add_csr(0xFD4, std::make_shared<basic_csr_t>(proc, 0xFD4, 0)); // KSCM4
+
   const reg_t senvcfg_mask = (proc->extension_enabled(EXT_ZICBOM) ? SENVCFG_CBCFE | SENVCFG_CBIE : 0) |
                             (proc->extension_enabled(EXT_ZICBOZ) ? SENVCFG_CBZE : 0) |
                             (proc->extension_enabled(EXT_SVUKTE) ? SENVCFG_UKTE : 0) |
diff --git a/riscv/insns/ebreak.h b/riscv/insns/ebreak.h
index 0cd2f190..b12e8015 100644
--- a/riscv/insns/ebreak.h
+++ b/riscv/insns/ebreak.h
@@ -6,5 +6,6 @@ if (!STATE.debug_mode && (
         (STATE.v && STATE.prv == PRV_U && STATE.dcsr->ebreakvu))) {
 	throw trap_debug_mode();
 } else {
-	throw trap_breakpoint(STATE.v, pc);
+    // CoralNPU Deviation: EBREAK should just halt the simulation cleanly.
+	exit(0);
 }
-- 
2.43.7

